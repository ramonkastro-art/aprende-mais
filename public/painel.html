<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel SMED â€” Aprende+</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#f5f3ee;--surface:#fff;--border:#e0d9d0;--accent:#2563eb;--accent2:#7c3aed;--text:#1a1814;--muted:#78716c;--shadow:0 2px 12px rgba(0,0,0,.07);}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
header{padding:18px 40px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);background:rgba(245,243,238,.95);backdrop-filter:blur(12px);position:sticky;top:0;z-index:10;}
.logo-text{font-family:'Fraunces',serif;font-size:22px;font-weight:900;letter-spacing:-1px;}
.logo-text span{color:var(--accent);}
.logo-sub{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;}
.badge-smed{margin-left:auto;padding:5px 14px;background:rgba(37,99,235,.07);border:1px solid rgba(37,99,235,.2);border-radius:20px;font-size:12px;color:var(--accent);font-weight:500;}

/* LOGIN */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:80vh;}
.login-card{background:#fff;border:1px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:380px;box-shadow:var(--shadow);text-align:center;}
.login-card h2{font-family:'Fraunces',serif;font-size:24px;font-weight:900;margin-bottom:8px;}
.login-card p{color:var(--muted);font-size:14px;margin-bottom:28px;}
.login-card input{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:10px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;background:var(--bg);margin-bottom:14px;transition:border-color .2s;}
.login-card input:focus{border-color:var(--accent);}
.login-card button{width:100%;padding:14px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;border-radius:10px;font-size:16px;font-family:'Fraunces',serif;font-weight:700;cursor:pointer;}
.login-error{color:#dc2626;font-size:13px;margin-top:10px;display:none;}

/* PAINEL */
#painelScreen{display:none;padding:36px 40px 80px;max-width:1100px;margin:0 auto;}
.painel-title{font-family:'Fraunces',serif;font-size:32px;font-weight:900;letter-spacing:-1px;margin-bottom:6px;}
.painel-title span{color:var(--accent);}
.painel-sub{color:var(--muted);font-size:14px;margin-bottom:32px;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:22px 24px;box-shadow:var(--shadow);}
.stat-value{font-family:'Fraunces',serif;font-size:36px;font-weight:900;color:var(--accent);line-height:1;}
.stat-label{font-size:13px;color:var(--muted);margin-top:6px;}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:32px;}
.chart-card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:var(--shadow);}
.chart-card h3{font-family:'Fraunces',serif;font-size:16px;font-weight:700;margin-bottom:16px;color:var(--text);}
.chart-wrap{position:relative;height:260px;}
.full-width{grid-column:1/-1;}
.table-card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:20px;}
.table-card h3{font-family:'Fraunces',serif;font-size:16px;font-weight:700;margin-bottom:16px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:10px 14px;background:var(--bg);color:var(--muted);font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);}
td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text);}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(37,99,235,.02);}
.loading-painel{text-align:center;padding:60px;color:var(--muted);}
.spinner-sm{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;}
@keyframes spin{to{transform:rotate(360deg)}}
.periodo-btns{display:flex;gap:8px;margin-bottom:24px;}
.periodo-btn{padding:7px 16px;border:1px solid var(--border);border-radius:20px;background:#fff;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.periodo-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
@media(max-width:700px){
  .charts-grid{grid-template-columns:1fr;}
  header{padding:14px 16px;}
  #painelScreen{padding:24px 16px 60px;}
}
</style>
</head>
<body>

<header>
  <div>
    <div class="logo-text">Aprende<span>+</span></div>
    <div class="logo-sub">Apoio PedagÃ³gico â€” Vacaria RS</div>
  </div>
  <div class="badge-smed">ðŸ“Š Painel SMED</div>
</header>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <h2>Painel de Uso</h2>
    <p>Acesso restrito Ã  Secretaria Municipal de EducaÃ§Ã£o</p>
    <input type="password" id="senhaInput" placeholder="Digite a senha" onkeydown="if(event.key==='Enter')entrar()">
    <button onclick="entrar()">Entrar â†’</button>
    <div class="login-error" id="loginError">Senha incorreta. Tente novamente.</div>
  </div>
</div>

<!-- PAINEL -->
<div id="painelScreen">
  <div class="loading-painel" id="loadingPainel">
    <div class="spinner-sm"></div>
    Carregando dados...
  </div>

  <div id="painelContent" style="display:none">
    <div class="painel-title">Painel de <span>Uso</span></div>
    <div class="painel-sub" id="painelSub"></div>

    <div class="periodo-btns">
      <button class="periodo-btn active" onclick="setPeriodo(7,this)">7 dias</button>
      <button class="periodo-btn" onclick="setPeriodo(30,this)">30 dias</button>
      <button class="periodo-btn" onclick="setPeriodo(90,this)">3 meses</button>
      <button class="periodo-btn" onclick="setPeriodo(0,this)">Tudo</button>
    </div>

    <div class="stats-grid" id="statsGrid"></div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>Componentes mais consultados</h3>
        <div class="chart-wrap"><canvas id="chartComponentes"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Anos / SÃ©ries</h3>
        <div class="chart-wrap"><canvas id="chartAnos"></canvas></div>
      </div>
      <div class="chart-card full-width">
        <h3>Consultas por dia</h3>
        <div class="chart-wrap"><canvas id="chartDias"></canvas></div>
      </div>
    </div>

    <div class="table-card">
      <h3>Ãšltimas consultas</h3>
      <table>
        <thead><tr><th>Data</th><th>Componente</th><th>Ano</th><th>Volume</th><th>PÃ¡gina</th></tr></thead>
        <tbody id="tabelaConsultas"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
let allData = [];
let charts = {};
let periodoAtivo = 7;

async function entrar() {
  const senha = document.getElementById('senhaInput').value;
  document.getElementById('loginError').style.display = 'none';

  const res = await fetch('/api/painel?senha=' + encodeURIComponent(senha));
  if (res.status === 401) {
    document.getElementById('loginError').style.display = 'block';
    return;
  }

  allData = await res.json();
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('painelScreen').style.display = 'block';
  renderPainel(periodoAtivo);
}

function setPeriodo(dias, btn) {
  periodoAtivo = dias;
  document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderPainel(dias);
}

function filtrarPorPeriodo(dados, dias) {
  if (!dias) return dados;
  const limite = new Date();
  limite.setDate(limite.getDate() - dias);
  return dados.filter(d => new Date(d.created_at) >= limite);
}

function renderPainel(dias) {
  const data = filtrarPorPeriodo(allData, dias);
  document.getElementById('loadingPainel').style.display = 'none';
  document.getElementById('painelContent').style.display = 'block';

  const label = dias ? `Ãšltimos ${dias} dias` : 'Todo o perÃ­odo';
  document.getElementById('painelSub').textContent = `${label} Â· ${data.length} consultas registradas`;

  // Stats
  const componentes = [...new Set(data.map(d => d.componente))];
  const hoje = data.filter(d => new Date(d.created_at).toDateString() === new Date().toDateString());
  const semana = filtrarPorPeriodo(allData, 7);

  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="stat-value">${data.length}</div><div class="stat-label">Total de consultas</div></div>
    <div class="stat-card"><div class="stat-value">${hoje.length}</div><div class="stat-label">Consultas hoje</div></div>
    <div class="stat-card"><div class="stat-value">${semana.length}</div><div class="stat-label">Ãšltimos 7 dias</div></div>
    <div class="stat-card"><div class="stat-value">${componentes.length}</div><div class="stat-label">Componentes usados</div></div>
  `;

  // Chart componentes
  const countComp = {};
  data.forEach(d => { countComp[d.componente] = (countComp[d.componente] || 0) + 1; });
  const compSorted = Object.entries(countComp).sort((a,b) => b[1]-a[1]);
  renderChart('chartComponentes', 'bar', compSorted.map(c=>c[0]), compSorted.map(c=>c[1]),
    ['#2563eb','#3b82f6','#60a5fa','#93c5fd','#7c3aed','#a78bfa','#059669','#10b981','#f59e0b','#ef4444']);

  // Chart anos
  const countAnos = {};
  data.forEach(d => { countAnos[d.ano] = (countAnos[d.ano] || 0) + 1; });
  const anosSorted = Object.entries(countAnos).sort((a,b) => a[0].localeCompare(b[0]));
  renderChart('chartAnos', 'doughnut', anosSorted.map(a=>a[0]), anosSorted.map(a=>a[1]),
    ['#2563eb','#7c3aed','#059669','#f59e0b']);

  // Chart dias
  const countDias = {};
  const hoje2 = new Date();
  const numDias = dias || 30;
  for (let i = numDias - 1; i >= 0; i--) {
    const d = new Date(hoje2); d.setDate(d.getDate() - i);
    countDias[d.toLocaleDateString('pt-BR')] = 0;
  }
  data.forEach(d => {
    const key = new Date(d.created_at).toLocaleDateString('pt-BR');
    if (countDias[key] !== undefined) countDias[key]++;
  });
  renderChart('chartDias', 'line', Object.keys(countDias), Object.values(countDias), ['#2563eb']);

  // Tabela
  const tbody = document.getElementById('tabelaConsultas');
  tbody.innerHTML = data.slice(0,50).map(d => `
    <tr>
      <td>${new Date(d.created_at).toLocaleString('pt-BR')}</td>
      <td>${d.componente || '-'}</td>
      <td>${d.ano || '-'}</td>
      <td>${d.volume || '-'}</td>
      <td>${d.pagina || '-'}</td>
    </tr>
  `).join('');
}

function renderChart(id, type, labels, values, colors) {
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  const isLine = type === 'line';
  charts[id] = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: isLine ? 'rgba(37,99,235,.1)' : colors,
        borderColor: isLine ? '#2563eb' : colors,
        borderWidth: isLine ? 2 : 1,
        fill: isLine,
        tension: isLine ? 0.4 : 0,
        pointBackgroundColor: isLine ? '#2563eb' : undefined,
        pointRadius: isLine ? 3 : undefined,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: type === 'doughnut' } },
      scales: type !== 'doughnut' ? {
        y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#f0ede8' } },
        x: { grid: { display: false }, ticks: { maxRotation: 45, font: { size: 11 } } }
      } : {}
    }
  });
}
</script>
</body>
</html>
